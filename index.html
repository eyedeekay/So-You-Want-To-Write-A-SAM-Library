<h1 id="so-you-want-to-write-a-sam-library">So You Want To Write A SAM Library</h1>
<p>One of the best features of I2P, in my opinion, is it's SAM API, which can be used to build a bridge between I2P and your application or language of choice. Currently, dozens of SAM libraries exist for a variety of languages, including:</p>
<ul>
<li><a href="https://github.com/i2p/i2psam">i2psam, for c++</a></li>
<li><a href="https://github.com/i2p/libsam3">libsam3, for C</a></li>
<li><a href="https://github.com/str4d/txi2p">txi2p for Python</a></li>
<li><a href="https://github.com/l-n-s/i2plib">i2plib for Python</a></li>
<li><a href="https://github.com/majestrate/i2p.socket">i2p.socket for Python</a></li>
<li><a href="https://github.com/MuxZeroNet/leaflet">leaflet for Python</a></li>
<li><a href="https://github.com/eyedeekay/gosam">gosam, for Go</a></li>
<li><a href="https://github.com/eyedeekay/sam3">sam3 for Go</a></li>
<li><a href="https://github.com/redhog/node-i2p">node-i2p for nodejs</a></li>
<li><a href="https://github.com/solatis/haskell-network-anonymous-i2p">haskell-network-anonymous-i2p</a></li>
<li><a href="https://github.com/SamuelFisher/i2pdotnet">i2pdotnet for .Net languages</a></li>
<li><a href="https://github.com/stallmanifold/rust-i2p">rust-i2p</a></li>
<li><a href="https://github.com/dryruby/i2p.rb">and i2p.rb for ruby</a></li>
</ul>
<p>If you're using any of these languages, you may be able to port your application to I2P already, using an existing library. That's not what this tutorial is about, though. This tutorial is about what to do if you want to create a SAM library in a new language. In this tutorial, I will implement a new SAM library in Java. I chose Java because there isn't a Java library that connects you to SAM yet, because of Java's use in Android, and because it's a language almost everybody has at least a <em>little</em> experience with, so hopefully you can translate it into a language of your choice.</p>
<h2 id="creating-your-library">Creating your library</h2>
<p>How you set up your own library will vary depending on the language you wish to use. For this example library, we'll be using java so we can create a library like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">mkdir</span> jsam</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="bu">cd</span> jsam</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ex">gradle</span> init --type java-library</a></code></pre></div>
<p>Or, if you are using gradle 5 or greater:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="ex">gradle</span> init --type java-library --project-name jsam</a></code></pre></div>
<h2 id="setting-up-the-library">Setting up the Library</h2>
<p>There are a few pieces of data that almost any SAM library should probably manage. It will at least need to store the address of the SAM Bridge you intend to use and the signature type you wish to use.</p>
<h3 id="storing-the-sam-address">Storing the SAM address</h3>
<p>I prefer to store the SAM address as a String and an Integer, and re-combine them in a function at runtime.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" title="1">    <span class="kw">public</span> <span class="bu">String</span> SAMHost = <span class="st">&quot;127.0.0.1&quot;</span>;</a>
<a class="sourceLine" id="cb1-2" title="2">    <span class="kw">public</span> <span class="dt">int</span> SAMPort = <span class="st">&quot;7656&quot;</span>;</a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">SAMAddress</span>(){</a>
<a class="sourceLine" id="cb1-4" title="4">        <span class="kw">return</span> SAMHost + <span class="st">&quot;:&quot;</span> + SAMPort;</a>
<a class="sourceLine" id="cb1-5" title="5">    }</a></code></pre></div>
<h3 id="storing-the-signature-type">Storing the Signature Type</h3>
<p>The valid signature types for an I2P Tunnel are DSA_SHA1, ECDSA_SHA256_P256, ECDSA_SHA384_P384, ECDSA_SHA512_P521, EdDSA_SHA512_Ed25519, but it is strongly recommended that you use EdDSA_SHA512_Ed25519 as a default if you implement at least SAM 3.1. In Java, the 'enum' datastructure lends itself to this task, as it is intended to contain a group of constants. Add the enum, and an instance of the enum, to your Java class definition.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb2-1" title="1">    <span class="kw">enum</span> SIGNATURE_TYPE {</a>
<a class="sourceLine" id="cb2-2" title="2">        DSA_SHA1,</a>
<a class="sourceLine" id="cb2-3" title="3">        ECDSA_SHA256_P256,</a>
<a class="sourceLine" id="cb2-4" title="4">        ECDSA_SHA384_P384,</a>
<a class="sourceLine" id="cb2-5" title="5">        ECDSA_SHA512_P521,</a>
<a class="sourceLine" id="cb2-6" title="6">        EdDSA_SHA512_Ed25519;</a>
<a class="sourceLine" id="cb2-7" title="7">    }</a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="kw">public</span> SIGNATURE_TYPE SigType = SIGNATURE_TYPE.<span class="fu">EdDSA_SHA512_Ed25519</span>;</a></code></pre></div>
<h3 id="retrieving-the-signature-type">Retrieving the signature type:</h3>
<p>That takes care of reliably storing the signature type in use by the SAM connection, but you've still got to retrieve it as a string to communicate it to the bridge.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb3-1" title="1">    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">SignatureType</span>() {</a>
<a class="sourceLine" id="cb3-2" title="2">        <span class="kw">switch</span> (SigType) {</a>
<a class="sourceLine" id="cb3-3" title="3">            <span class="kw">case</span> DSA_SHA1:</a>
<a class="sourceLine" id="cb3-4" title="4">                <span class="kw">return</span> <span class="st">&quot;SIGNATURE_TYPE=DSA_SHA1&quot;</span>;</a>
<a class="sourceLine" id="cb3-5" title="5">            <span class="kw">case</span> ECDSA_SHA256_P256:</a>
<a class="sourceLine" id="cb3-6" title="6">                <span class="kw">return</span> <span class="st">&quot;SIGNATURE_TYPE=ECDSA_SHA256_P256&quot;</span>;</a>
<a class="sourceLine" id="cb3-7" title="7">            <span class="kw">case</span> ECDSA_SHA384_P384:</a>
<a class="sourceLine" id="cb3-8" title="8">                <span class="kw">return</span> <span class="st">&quot;SIGNATURE_TYPE=ECDSA_SHA384_P384&quot;</span>;</a>
<a class="sourceLine" id="cb3-9" title="9">            <span class="kw">case</span> ECDSA_SHA512_P521:</a>
<a class="sourceLine" id="cb3-10" title="10">                <span class="kw">return</span> <span class="st">&quot;SIGNATURE_TYPE=ECDSA_SHA512_P521&quot;</span>;</a>
<a class="sourceLine" id="cb3-11" title="11">            <span class="kw">case</span> EdDSA_SHA512_Ed25519:</a>
<a class="sourceLine" id="cb3-12" title="12">                <span class="kw">return</span> <span class="st">&quot;SIGNATURE_TYPE=EdDSA_SHA512_Ed25519&quot;</span>;</a>
<a class="sourceLine" id="cb3-13" title="13">        }</a>
<a class="sourceLine" id="cb3-14" title="14">        <span class="kw">return</span> <span class="st">&quot;&quot;</span>;</a>
<a class="sourceLine" id="cb3-15" title="15">    }</a></code></pre></div>
<p>It's important to test things, so let's write some tests:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb4-1" title="1">    <span class="at">@Test</span> <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testValidDefaultSAMAddress</span>() {</a>
<a class="sourceLine" id="cb4-2" title="2">        Jsam classUnderTest = <span class="kw">new</span> <span class="fu">Jsam</span>();</a>
<a class="sourceLine" id="cb4-3" title="3">        <span class="fu">assertEquals</span>(<span class="st">&quot;127.0.0.1:7656&quot;</span>, classUnderTest.<span class="fu">SAMAddress</span>());</a>
<a class="sourceLine" id="cb4-4" title="4">    }</a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="at">@Test</span> <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testValidDefaultSignatureType</span>() {</a>
<a class="sourceLine" id="cb4-6" title="6">        Jsam classUnderTest = <span class="kw">new</span> <span class="fu">Jsam</span>();</a>
<a class="sourceLine" id="cb4-7" title="7">        <span class="fu">assertEquals</span>(<span class="st">&quot;EdDSA_SHA512_Ed25519&quot;</span>, classUnderTest.<span class="fu">SignatureType</span>());</a>
<a class="sourceLine" id="cb4-8" title="8">    }</a></code></pre></div>
<p>Once that's done, begin creating your constructor. Note that we've given our library defaults which will be useful in default situations on all existing I2P routers so far.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" title="1">    <span class="kw">public</span> <span class="fu">Jsam</span>(<span class="bu">String</span> host, <span class="dt">int</span> port, SIGNATURE_TYPE sig) {</a>
<a class="sourceLine" id="cb5-2" title="2">        SAMHost = host;</a>
<a class="sourceLine" id="cb5-3" title="3">        SAMPort = port;</a>
<a class="sourceLine" id="cb5-4" title="4">        SigType = sig;</a>
<a class="sourceLine" id="cb5-5" title="5">    }</a></code></pre></div>
<h2 id="establishing-a-sam-connection">Establishing a SAM Connection</h2>
<p>Finally, the good part. Interaction with the SAM bridge is done by sending a &quot;command&quot; to the address of the SAM bridge, and you can parse the result of the command as a set of string-based key-value pairs. So bearing that in mind, let's estabish a read-write connection to the SAM Address we defined before, then write a &quot;CommandSAM&quot; Function and a reply parser.</p>
<h3 id="connecting-to-the-sam-port">Connecting to the SAM Port</h3>
<p>We're communicating with SAM via a Socket, so in order to connect to, read from, and write to the socket, you'll need to create the following private variables in the Jsam class:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb6-1" title="1">    <span class="kw">private</span> <span class="bu">Socket</span> socket;</a>
<a class="sourceLine" id="cb6-2" title="2">    <span class="kw">private</span> <span class="bu">PrintWriter</span> writer;</a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="kw">private</span> <span class="bu">BufferedReader</span> reader;</a></code></pre></div>
<p>You will also want to instantiate those variables in your Constructors by creating a function to do so.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb7-1" title="1">    <span class="kw">public</span> <span class="fu">Jsam</span>(<span class="bu">String</span> host, <span class="dt">int</span> port, SIGNATURE_TYPE sig) {</a>
<a class="sourceLine" id="cb7-2" title="2">        SAMHost = host;</a>
<a class="sourceLine" id="cb7-3" title="3">        SAMPort = port;</a>
<a class="sourceLine" id="cb7-4" title="4">        SigType = sig;</a>
<a class="sourceLine" id="cb7-5" title="5">        <span class="fu">startConnection</span>();</a>
<a class="sourceLine" id="cb7-6" title="6">    }</a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">startConnection</span>() {</a>
<a class="sourceLine" id="cb7-8" title="8">        <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb7-9" title="9">            socket = <span class="kw">new</span> <span class="bu">Socket</span>(SAMHost, SAMPort);</a>
<a class="sourceLine" id="cb7-10" title="10">            writer = <span class="kw">new</span> <span class="bu">PrintWriter</span>(socket.<span class="fu">getOutputStream</span>(), <span class="kw">true</span>);</a>
<a class="sourceLine" id="cb7-11" title="11">            reader = <span class="kw">new</span> <span class="bu">BufferedReader</span>(<span class="kw">new</span> <span class="bu">InputStreamReader</span>(socket.<span class="fu">getInputStream</span>()));</a>
<a class="sourceLine" id="cb7-12" title="12">        } <span class="kw">catch</span> (<span class="bu">Exception</span> e) {</a>
<a class="sourceLine" id="cb7-13" title="13">            <span class="co">//omitted for brevity</span></a>
<a class="sourceLine" id="cb7-14" title="14">        }</a>
<a class="sourceLine" id="cb7-15" title="15">    }</a></code></pre></div>
<h3 id="sending-a-command-to-sam">Sending a Command to SAM</h3>
<p>Now you're all set up to finally start talking to SAM. In order to keep things nicely organized, let's create a function which sends a single command to SAM, terminated by a newline, and which returns a Reply object, which we will create in the next step:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb8-1" title="1">    <span class="kw">public</span> Reply <span class="fu">CommandSAM</span>(<span class="bu">String</span> args) {</a>
<a class="sourceLine" id="cb8-2" title="2">        writer.<span class="fu">println</span>(args + <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb8-3" title="3">        <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb8-4" title="4">            <span class="bu">String</span> repl = reader.<span class="fu">readLine</span>();</a>
<a class="sourceLine" id="cb8-5" title="5">            <span class="kw">return</span> <span class="kw">new</span> <span class="fu">Reply</span>(repl);</a>
<a class="sourceLine" id="cb8-6" title="6">        } <span class="kw">catch</span> (<span class="bu">Exception</span> e) {</a>
<a class="sourceLine" id="cb8-7" title="7">            <span class="co">//omitted for brevity</span></a>
<a class="sourceLine" id="cb8-8" title="8">        }</a>
<a class="sourceLine" id="cb8-9" title="9">    }</a></code></pre></div>
<p>Note that we are using the writer and reader we created from the socket in the previous step as our inputs and outputs to the socket. When we get a reply from the reader, we pass the string to the Reply constructor, which parses it and returns the Reply object.</p>
<h3 id="parsing-a-reply-and-creating-a-reply-object">Parsing a reply and creating a Reply object.</h3>
<p>In order to more easily handle replies, we'll use a Reply object to automatically parse the results we get from the SAM bridge. A reply has at least a topic, a type, and a result, as well as an arbitrary number of key-value pairs.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">public</span> <span class="kw">class</span> Reply {</a>
<a class="sourceLine" id="cb9-2" title="2">    <span class="bu">String</span> topic;</a>
<a class="sourceLine" id="cb9-3" title="3">    <span class="bu">String</span> type;</a>
<a class="sourceLine" id="cb9-4" title="4">    REPLY_TYPES result;</a>
<a class="sourceLine" id="cb9-5" title="5">    <span class="bu">Map</span>&lt;<span class="bu">String</span>, <span class="bu">String</span>&gt; replyMap = <span class="kw">new</span> <span class="bu">HashMap</span>&lt;<span class="bu">String</span>, <span class="bu">String</span>&gt;();</a></code></pre></div>
<p>As you can see, we will be storing the &quot;result&quot; as an enum, REPLY_TYPES. This enum contains all the possible reply results which the SAM bridge might respond with.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb10-1" title="1">    <span class="kw">enum</span> REPLY_TYPES {</a>
<a class="sourceLine" id="cb10-2" title="2">        OK,</a>
<a class="sourceLine" id="cb10-3" title="3">        CANT_REACH_PEER,</a>
<a class="sourceLine" id="cb10-4" title="4">        DUPLICATED_ID,</a>
<a class="sourceLine" id="cb10-5" title="5">        DUPLICATED_DEST,</a>
<a class="sourceLine" id="cb10-6" title="6">        I2P_ERROR,</a>
<a class="sourceLine" id="cb10-7" title="7">        INVALID_KEY,</a>
<a class="sourceLine" id="cb10-8" title="8">        KEY_NOT_FOUND,</a>
<a class="sourceLine" id="cb10-9" title="9">        PEER_NOT_FOUND,</a>
<a class="sourceLine" id="cb10-10" title="10">        <span class="bu">TIMEOUT</span>;</a>
<a class="sourceLine" id="cb10-11" title="11">        <span class="kw">public</span> <span class="dt">static</span> REPLY_TYPES <span class="fu">set</span>(<span class="bu">String</span> type) {</a>
<a class="sourceLine" id="cb10-12" title="12">            <span class="bu">String</span> temp = type.<span class="fu">trim</span>();</a>
<a class="sourceLine" id="cb10-13" title="13">            <span class="kw">switch</span> (temp) {</a>
<a class="sourceLine" id="cb10-14" title="14">            <span class="kw">case</span> <span class="st">&quot;RESULT=OK&quot;</span>:</a>
<a class="sourceLine" id="cb10-15" title="15">                <span class="kw">return</span> OK;</a>
<a class="sourceLine" id="cb10-16" title="16">            <span class="kw">case</span> <span class="st">&quot;RESULT=CANT_REACH_PEER&quot;</span>:</a>
<a class="sourceLine" id="cb10-17" title="17">                <span class="kw">return</span> CANT_REACH_PEER;</a>
<a class="sourceLine" id="cb10-18" title="18">            <span class="kw">case</span> <span class="st">&quot;RESULT=DUPLICATED_ID&quot;</span>:</a>
<a class="sourceLine" id="cb10-19" title="19">                <span class="kw">return</span> DUPLICATED_ID;</a>
<a class="sourceLine" id="cb10-20" title="20">            <span class="kw">case</span> <span class="st">&quot;RESULT=DUPLICATED_DEST&quot;</span>:</a>
<a class="sourceLine" id="cb10-21" title="21">                <span class="kw">return</span> DUPLICATED_DEST;</a>
<a class="sourceLine" id="cb10-22" title="22">            <span class="kw">case</span> <span class="st">&quot;RESULT=I2P_ERROR&quot;</span>:</a>
<a class="sourceLine" id="cb10-23" title="23">                <span class="kw">return</span> I2P_ERROR;</a>
<a class="sourceLine" id="cb10-24" title="24">            <span class="kw">case</span> <span class="st">&quot;RESULT=INVALID_KEY&quot;</span>:</a>
<a class="sourceLine" id="cb10-25" title="25">                <span class="kw">return</span> INVALID_KEY;</a>
<a class="sourceLine" id="cb10-26" title="26">            <span class="kw">case</span> <span class="st">&quot;RESULT=KEY_NOT_FOUND&quot;</span>:</a>
<a class="sourceLine" id="cb10-27" title="27">                <span class="kw">return</span> KEY_NOT_FOUND;</a>
<a class="sourceLine" id="cb10-28" title="28">            <span class="kw">case</span> <span class="st">&quot;RESULT=PEER_NOT_FOUND&quot;</span>:</a>
<a class="sourceLine" id="cb10-29" title="29">                <span class="kw">return</span> PEER_NOT_FOUND;</a>
<a class="sourceLine" id="cb10-30" title="30">            <span class="kw">case</span> <span class="st">&quot;RESULT=TIMEOUT&quot;</span>:</a>
<a class="sourceLine" id="cb10-31" title="31">                <span class="kw">return</span> <span class="bu">TIMEOUT</span>;</a>
<a class="sourceLine" id="cb10-32" title="32">            }</a>
<a class="sourceLine" id="cb10-33" title="33">            <span class="kw">return</span> I2P_ERROR;</a>
<a class="sourceLine" id="cb10-34" title="34">        }</a>
<a class="sourceLine" id="cb10-35" title="35">        <span class="kw">public</span> <span class="dt">static</span> <span class="bu">String</span> <span class="fu">get</span>(REPLY_TYPES type) {</a>
<a class="sourceLine" id="cb10-36" title="36">            <span class="kw">switch</span> (type) {</a>
<a class="sourceLine" id="cb10-37" title="37">            <span class="kw">case</span> OK:</a>
<a class="sourceLine" id="cb10-38" title="38">                <span class="kw">return</span> <span class="st">&quot;RESULT=OK&quot;</span>;</a>
<a class="sourceLine" id="cb10-39" title="39">            <span class="kw">case</span> CANT_REACH_PEER:</a>
<a class="sourceLine" id="cb10-40" title="40">                <span class="kw">return</span> <span class="st">&quot;RESULT=CANT_REACH_PEER&quot;</span>;</a>
<a class="sourceLine" id="cb10-41" title="41">            <span class="kw">case</span> DUPLICATED_ID:</a>
<a class="sourceLine" id="cb10-42" title="42">                <span class="kw">return</span> <span class="st">&quot;RESULT=DUPLICATED_ID&quot;</span>;</a>
<a class="sourceLine" id="cb10-43" title="43">            <span class="kw">case</span> DUPLICATED_DEST:</a>
<a class="sourceLine" id="cb10-44" title="44">                <span class="kw">return</span> <span class="st">&quot;RESULT=DUPLICATED_DEST&quot;</span>;</a>
<a class="sourceLine" id="cb10-45" title="45">            <span class="kw">case</span> I2P_ERROR:</a>
<a class="sourceLine" id="cb10-46" title="46">                <span class="kw">return</span> <span class="st">&quot;RESULT=I2P_ERROR&quot;</span>;</a>
<a class="sourceLine" id="cb10-47" title="47">            <span class="kw">case</span> INVALID_KEY:</a>
<a class="sourceLine" id="cb10-48" title="48">                <span class="kw">return</span> <span class="st">&quot;RESULT=INVALID_KEY&quot;</span>;</a>
<a class="sourceLine" id="cb10-49" title="49">            <span class="kw">case</span> KEY_NOT_FOUND:</a>
<a class="sourceLine" id="cb10-50" title="50">                <span class="kw">return</span> <span class="st">&quot;RESULT=KEY_NOT_FOUND&quot;</span>;</a>
<a class="sourceLine" id="cb10-51" title="51">            <span class="kw">case</span> PEER_NOT_FOUND:</a>
<a class="sourceLine" id="cb10-52" title="52">                <span class="kw">return</span> <span class="st">&quot;RESULT=PEER_NOT_FOUND&quot;</span>;</a>
<a class="sourceLine" id="cb10-53" title="53">            <span class="kw">case</span> <span class="bu">TIMEOUT</span>:</a>
<a class="sourceLine" id="cb10-54" title="54">                <span class="kw">return</span> <span class="st">&quot;RESULT=TIMEOUT&quot;</span>;</a>
<a class="sourceLine" id="cb10-55" title="55">            }</a>
<a class="sourceLine" id="cb10-56" title="56">            <span class="kw">return</span> <span class="st">&quot;RESULT=I2P_ERROR&quot;</span>;</a>
<a class="sourceLine" id="cb10-57" title="57">        }</a>
<a class="sourceLine" id="cb10-58" title="58">    };</a></code></pre></div>
<p>Now let's create our constructor, which takes the reply string recieved from the socket as a parameter, parses it, and uses the information to set up the reply object. The reply is space-delimited, with key-value pairs joined by an equal sign and terminated by a newline.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb11-1" title="1">    <span class="kw">public</span> <span class="fu">Reply</span>(<span class="bu">String</span> reply) {</a>
<a class="sourceLine" id="cb11-2" title="2">        <span class="bu">String</span> trimmed = reply.<span class="fu">trim</span>();</a>
<a class="sourceLine" id="cb11-3" title="3">        <span class="bu">String</span>[] replyvalues = reply.<span class="fu">split</span>(<span class="st">&quot; &quot;</span>);</a>
<a class="sourceLine" id="cb11-4" title="4">        <span class="kw">if</span> (replyvalues.<span class="fu">length</span> &lt; <span class="dv">3</span>) {</a>
<a class="sourceLine" id="cb11-5" title="5">            <span class="co">//omitted for brevity</span></a>
<a class="sourceLine" id="cb11-6" title="6">        }</a>
<a class="sourceLine" id="cb11-7" title="7">        topic = replyvalues[<span class="dv">0</span>];</a>
<a class="sourceLine" id="cb11-8" title="8">        type = replyvalues[<span class="dv">1</span>];</a>
<a class="sourceLine" id="cb11-9" title="9">        result = REPLY_TYPES.<span class="fu">set</span>(replyvalues[<span class="dv">2</span>]);</a>
<a class="sourceLine" id="cb11-10" title="10"></a>
<a class="sourceLine" id="cb11-11" title="11">        <span class="bu">String</span>[] replyLast = <span class="bu">Arrays</span>.<span class="fu">copyOfRange</span>(replyvalues, <span class="dv">3</span>, replyvalues.<span class="fu">length</span>);</a>
<a class="sourceLine" id="cb11-12" title="12">        <span class="kw">for</span> (<span class="dt">int</span> x = <span class="dv">0</span>; x &lt; replyLast.<span class="fu">length</span>; x++) {</a>
<a class="sourceLine" id="cb11-13" title="13">            <span class="bu">String</span>[] kv = replyLast[x].<span class="fu">split</span>(<span class="st">&quot;=&quot;</span>);</a>
<a class="sourceLine" id="cb11-14" title="14">            <span class="kw">if</span> (kv.<span class="fu">length</span> != <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb11-15" title="15"></a>
<a class="sourceLine" id="cb11-16" title="16">            }</a>
<a class="sourceLine" id="cb11-17" title="17">            replyMap.<span class="fu">put</span>(kv[<span class="dv">0</span>], kv[<span class="dv">1</span>]);</a>
<a class="sourceLine" id="cb11-18" title="18">        }</a>
<a class="sourceLine" id="cb11-19" title="19">    }</a></code></pre></div>
<p>Lastly, for the sake of convenience, let's give the reply object a toString() function which returns a string representation of the Reply object.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb12-1" title="1">    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span>() {</a>
<a class="sourceLine" id="cb12-2" title="2">        <span class="kw">return</span> topic + <span class="st">&quot; &quot;</span> + type + <span class="st">&quot; &quot;</span> + REPLY_TYPES.<span class="fu">get</span>(result) + <span class="st">&quot; &quot;</span> + replyMap.<span class="fu">toString</span>();</a>
<a class="sourceLine" id="cb12-3" title="3">    }</a>
<a class="sourceLine" id="cb12-4" title="4">}</a></code></pre></div>
<h3 id="saying-hello-to-sam">Saying &quot;HELLO&quot; to SAM</h3>
<p>Now we're ready to establish communication with SAM by sending a &quot;Hello&quot; message. If you're writing a new SAM library, you should probably target at least SAM 3.1, since it's available in both I2P and i2pd and introduces support for the SIGNATURE_TYPE parameter.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb13-1" title="1">    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">HelloSAM</span>() {</a>
<a class="sourceLine" id="cb13-2" title="2">        Reply repl = <span class="fu">CommandSAM</span>(<span class="st">&quot;HELLO VERSION MIN=3.0 MAX=3.1 </span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb13-3" title="3">        <span class="kw">if</span> (repl.<span class="fu">result</span> == Reply.<span class="fu">REPLY_TYPES</span>.<span class="fu">OK</span>) {</a>
<a class="sourceLine" id="cb13-4" title="4">            <span class="kw">return</span> <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb13-5" title="5">        }</a>
<a class="sourceLine" id="cb13-6" title="6">        <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(repl.<span class="fu">String</span>());</a>
<a class="sourceLine" id="cb13-7" title="7">        <span class="kw">return</span> <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb13-8" title="8">    }</a></code></pre></div>
<p>As you can see, we use the CommandSAM function we created before to send the newline-terminated command <code>HELLO VERSION MIN=3.0 MAX=3.1 \n</code>. This tells SAM that you want to start communicating with the API, and that you know how to speak SAM version 3.0 and 3.1. The router, in turn, will respond with like <code>HELLO REPLY RESULT=OK VERSION=3.1</code> which is a string you can pass to the Reply constructor to get a valid Reply object. From now on, we can use our CommandSAM function and Reply object to deal with all our communication across the SAM bridge.</p>
<p>Finally, let's add a test for our &quot;HelloSAM&quot; function.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb14-1" title="1">    <span class="at">@Test</span> <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testHelloSAM</span>() {</a>
<a class="sourceLine" id="cb14-2" title="2">        Jsam classUnderTest = <span class="kw">new</span> <span class="fu">Jsam</span>();</a>
<a class="sourceLine" id="cb14-3" title="3">        <span class="fu">assertTrue</span>(<span class="st">&quot;HelloSAM should return &#39;true&#39; in the presence of an alive SAM bridge&quot;</span>, classUnderTest.<span class="fu">HelloSAM</span>());</a>
<a class="sourceLine" id="cb14-4" title="4">    }</a>
<a class="sourceLine" id="cb14-5" title="5"></a></code></pre></div>
<h3 id="creating-a-session-for-your-application">Creating a &quot;Session&quot; for your application</h3>
<p>Now that you've negotiated your connection to SAM and agreed on a SAM version you both speak, you can set up peer-to-peer connections for your application to connect to other i2p applications. You do this by sending a &quot;SESSION CREATE&quot; command to the SAM Bridge. To do that, we'll use a CreateSession function that accepts a session ID and a destination type parameter.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" title="1">    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">CreateSession</span>(<span class="bu">String</span> id, <span class="bu">String</span> destination ) {</a>
<a class="sourceLine" id="cb1-2" title="2">        <span class="kw">if</span> (destination == <span class="st">&quot;&quot;</span>) {</a>
<a class="sourceLine" id="cb1-3" title="3">            destination = <span class="st">&quot;TRANSIENT&quot;</span>;</a>
<a class="sourceLine" id="cb1-4" title="4">        }</a>
<a class="sourceLine" id="cb1-5" title="5">        Reply repl = <span class="fu">CommandSAM</span>(<span class="st">&quot;SESSION CREATE STYLE=STREAM ID=&quot;</span> + ID + <span class="st">&quot; DESTINATION=&quot;</span> + destination);</a>
<a class="sourceLine" id="cb1-6" title="6">        <span class="kw">if</span> (repl.<span class="fu">result</span> == Reply.<span class="fu">REPLY_TYPES</span>.<span class="fu">OK</span>) {</a>
<a class="sourceLine" id="cb1-7" title="7">            <span class="kw">return</span> id;</a>
<a class="sourceLine" id="cb1-8" title="8">        }</a>
<a class="sourceLine" id="cb1-9" title="9">        <span class="kw">return</span> <span class="st">&quot;&quot;</span>;</a>
<a class="sourceLine" id="cb1-10" title="10">    }</a></code></pre></div>
<p>That was easy, right? All we had to do was adapt the pattern we used in our HelloSAM function to the <code>SESSION CREATE</code> command. A good reply from the bridge will still return OK, and in that case we return the ID of the newly created SAM connection. Otherwise, we return an empty string because that's an invalid ID anyway and it failed, so it's easy to check. Let's see if this function works by writing a test for it:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode Java"><code class="sourceCode java"><a class="sourceLine" id="cb2-1" title="1">    <span class="at">@Test</span> <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testCreateSession</span>() {</a>
<a class="sourceLine" id="cb2-2" title="2">        Jsam classUnderTest = <span class="kw">new</span> <span class="fu">Jsam</span>();</a>
<a class="sourceLine" id="cb2-3" title="3">        <span class="fu">assertTrue</span>(<span class="st">&quot;HelloSAM should return &#39;true&#39; in the presence of an alive SAM bridge&quot;</span>, classUnderTest.<span class="fu">HelloSAM</span>());</a>
<a class="sourceLine" id="cb2-4" title="4">        <span class="fu">assertEquals</span>(<span class="st">&quot;test&quot;</span>, classUnderTest.<span class="fu">CreateSession</span>(<span class="st">&quot;test&quot;</span>, <span class="st">&quot;&quot;</span>));</a>
<a class="sourceLine" id="cb2-5" title="5">    }</a></code></pre></div>
<p>Note that in this test, we <em>must</em> call HelloSAM first to establish communication with SAM before starting our session. If not, the bridge will reply with an error and the test will fail.</p>
<h3 id="looking-up-hosts-by-name-or-b32">Looking up Hosts by name or .b32</h3>
<p>Now you have your session established and your local destination, and need to decide what you want to do with them. Your session can now be commanded to connect to a remote service over I2P, or to wait for incoming connections to respond to. However, before you can connect to a remote destination, you may need to obtain the base64 of the destination, which is what the API expects. In order to do this, we'll create a LookupName function, which will return the base64 in a usable form.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode Java"><code class="sourceCode java"></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode Java"><code class="sourceCode java"></code></pre></div>
<h3 id="sending-and-recieving-information">Sending and Recieving Information</h3>

